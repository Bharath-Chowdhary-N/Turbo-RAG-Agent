name: Cross-Repo Sync and Incremental Vector Update

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      full_reprocess:
        description: 'Force full reprocessing of all files'
        required: false
        default: 'false'
        type: boolean
  
  # Triggered by repository_dispatch from the source repo
  repository_dispatch:
    types: [panstarrs_pipeline_update]
  
  # Weekly full reprocessing on Sunday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

env:
  SOURCE_REPO: 'patkel/turbo_telescope'
  SOURCE_BRANCH: 'panstarrs_pipeline'
  DEST_DIR: 'data/github_repos'
  CHROMA_PERSIST_DIR: ./chroma_db
  PYTHON_VERSION: '3.10'

jobs:
  sync-and-process:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours for full processing
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        lfs: true
        fetch-depth: 0
    
    - name: Checkout LFS objects
      run: git lfs pull
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clone source repository
      run: |
        echo "üì• Cloning source repository: ${{ env.SOURCE_REPO }}"
        git clone --depth 1 --branch ${{ env.SOURCE_BRANCH }} \
          https://${{ secrets.PAT_TOKEN }}@github.com/${{ env.SOURCE_REPO }}.git \
          /tmp/source_repo
    
    - name: Determine processing mode
      id: mode
      run: |
        # Check if this is a scheduled full reprocess or manual full reprocess
        if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event.inputs.full_reprocess }}" == "true" ]]; then
          echo "üîÑ FULL PROCESSING MODE"
          echo "mode=full" >> $GITHUB_OUTPUT
        else
          echo "üéØ INCREMENTAL PROCESSING MODE"
          echo "mode=incremental" >> $GITHUB_OUTPUT
        fi
        
        echo "Processing mode: $(cat $GITHUB_OUTPUT | grep mode)"
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        lfs: true
        fetch-depth: 0
    
    - name: Checkout LFS objects
      run: git lfs pull
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clone source repository
      run: |
        echo "üì• Cloning source repository: ${{ env.SOURCE_REPO }}"
        git clone --depth 1 --branch ${{ env.SOURCE_BRANCH }} \
          https://${{ secrets.PAT_TOKEN }}@github.com/${{ env.SOURCE_REPO }}.git \
          /tmp/source_repo
    
    - name: Detect changed files
      id: changes
      if: steps.mode.outputs.mode == 'incremental'
      run: |
        # Get changed files from webhook payload (only for incremental mode)
        if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
          echo "üìù Detecting changed files from commit webhook"
          echo '${{ toJson(github.event.client_payload) }}' | jq -r '.commits[].modified[]' > /tmp/changed_files.txt 2>/dev/null || true
          echo '${{ toJson(github.event.client_payload) }}' | jq -r '.commits[].added[]' >> /tmp/changed_files.txt 2>/dev/null || true
          echo '${{ toJson(github.event.client_payload) }}' | jq -r '.commits[].removed[]' > /tmp/removed_files.txt 2>/dev/null || true
        else
          # Manual trigger without full_reprocess flag
          echo "üì¶ Manual incremental trigger"
          touch /tmp/changed_files.txt
          touch /tmp/removed_files.txt
        fi
        
        echo "Changed files:"
        cat /tmp/changed_files.txt || echo "None"
    
    - name: Sync changed files (Incremental Mode)
      id: sync_incremental
      if: steps.mode.outputs.mode == 'incremental'
      run: |
        SOURCE_PATH="/tmp/source_repo"
        DEST_PATH="${{ env.DEST_DIR }}"
        
        echo "üîÑ Syncing changed files to $DEST_PATH"
        mkdir -p "$DEST_PATH"
        
        # Create file list for vector processing
        rm -f /tmp/files_to_process.txt
        touch /tmp/files_to_process.txt
        
        CHANGED_COUNT=0
        
        # If webhook provided specific files, sync only those
        if [[ -s /tmp/changed_files.txt ]]; then
          echo "üìù Syncing only changed files"
          
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$SOURCE_PATH/$file" ]; then
              # Create directory structure
              mkdir -p "$DEST_PATH/$(dirname "$file")"
              
              # Copy file
              cp -f "$SOURCE_PATH/$file" "$DEST_PATH/$file"
              echo "‚úì Synced: $file"
              
              # Add to processing list with full path
              echo "$DEST_PATH/$file" >> /tmp/files_to_process.txt
              
              ((CHANGED_COUNT++))
            fi
          done < /tmp/changed_files.txt
          
          # Handle removed files
          if [ -s /tmp/removed_files.txt ]; then
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                if [ -f "$DEST_PATH/$file" ]; then
                  echo "üóëÔ∏è Removing: $file"
                  rm -f "$DEST_PATH/$file"
                fi
                # Mark for vector DB removal
                echo "REMOVED:$DEST_PATH/$file" >> /tmp/files_to_process.txt
                ((CHANGED_COUNT++))
              fi
            done < /tmp/removed_files.txt
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "files_changed=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "üìä Changed: $CHANGED_COUNT file(s)"
        else
          # Manual trigger without webhook - sync all but process intelligently
          echo "üì¶ Syncing all files (manual trigger)"
          
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            "$SOURCE_PATH/" "$DEST_PATH/"
          
          # Let processor detect what's new/changed
          echo "MANUAL_SYNC_ALL" > /tmp/files_to_process.txt
          
          CHANGED_COUNT=$(find "$DEST_PATH" -type f | wc -l)
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "files_changed=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "üìä Total files: $CHANGED_COUNT"
        fi
        
        echo "Files marked for vector processing:"
        cat /tmp/files_to_process.txt
    
    - name: Sync all files (Full Mode)
      id: sync_full
      if: steps.mode.outputs.mode == 'full'
      run: |
        SOURCE_PATH="/tmp/source_repo"
        DEST_PATH="${{ env.DEST_DIR }}"
        
        echo "üì¶ FULL SYNC - Syncing all files to $DEST_PATH"
        mkdir -p "$DEST_PATH"
        
        rsync -av --delete \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='*.pyc' \
          --exclude='__pycache__' \
          "$SOURCE_PATH/" "$DEST_PATH/"
        
        TOTAL_FILES=$(find "$DEST_PATH" -type f | wc -l)
        echo "has_changes=true" >> $GITHUB_OUTPUT
        echo "files_changed=$TOTAL_FILES" >> $GITHUB_OUTPUT
        echo "üìä Total files synced: $TOTAL_FILES"
    
    - name: Track with Git LFS
      run: |
        cd ${{ env.DEST_DIR }}
        find . -type f -size +100M -exec git lfs track {} \; 2>/dev/null || true
        git lfs track "*.fits" 2>/dev/null || true
        git lfs track "*.hdf5" 2>/dev/null || true
        git lfs track "*.h5" 2>/dev/null || true
        git lfs track "*.parquet" 2>/dev/null || true
        git lfs track "*.pkl" 2>/dev/null || true
    
    - name: Commit and push changes
      id: commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Force add files (in case .gitignore blocks them)
        git add -f ${{ env.DEST_DIR }}
        git add .gitattributes 2>/dev/null || true
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          COMMIT_MSG="üîÑ Sync from ${{ env.SOURCE_REPO }}@${{ env.SOURCE_BRANCH }}"
          
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            COMMIT_MSG="$COMMIT_MSG - Commit ${{ github.event.client_payload.after }}"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Changes committed and pushed"
        fi
    
    - name: Process Vectors (Incremental Only)
      if: steps.commit.outputs.has_changes == 'true'
      run: |
        if [ -f /tmp/files_to_process.txt ] && [ -s /tmp/files_to_process.txt ]; then
          FILE_LIST=$(cat /tmp/files_to_process.txt)
          
          if [[ "$FILE_LIST" == "MANUAL_SYNC_ALL" ]]; then
            echo "üîç Manual sync - processing only new/changed files based on vector DB comparison"
            python ci_vector_processor.py \
              --data-dir ./data \
              --smart-incremental
          else
            FILE_COUNT=$(wc -l < /tmp/files_to_process.txt)
            echo "üéØ Processing $FILE_COUNT changed file(s)"
            
            python ci_vector_processor.py \
              --data-dir ./data \
              --file-list /tmp/files_to_process.txt \
              --incremental
          fi
        else
          echo "‚ö†Ô∏è No files to process"
        fi
      timeout-minutes: 15
    
    - name: Validate Processing Results
      if: steps.commit.outputs.has_changes == 'true'
      run: |
        if [ -f "processing_results.json" ]; then
          echo "‚úÖ Processing completed successfully!"
          cat processing_results.json | python -m json.tool
        else
          echo "‚ùå No processing results file found!"
          exit 1
        fi
    
    - name: Upload Processing Results
      if: steps.commit.outputs.has_changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: processing-results-${{ github.run_number }}
        path: |
          processing_results.json
          /tmp/files_to_process.txt
          /tmp/changed_files.txt
        retention-days: 30
    
    - name: Slack Notification
      if: always()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_TITLE: 'Incremental Vector Update'
        SLACK_MESSAGE: |
          Status: ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
          Source: ${{ env.SOURCE_REPO }}@${{ env.SOURCE_BRANCH }}
          Files Changed: ${{ steps.sync.outputs.files_changed }}
          Processing: ${{ steps.commit.outputs.has_changes == 'true' && 'Completed' || 'No changes' }}
          Trigger: ${{ github.event_name }}
        SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
